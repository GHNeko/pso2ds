<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>PSO2ダメージ計算機</title>
    <link rel="stylesheet" href="css/spectre.min.css">
    <link rel="stylesheet" href="css/spectre-exp.min.css">
    <link rel="stylesheet" href="css/spectre-icons.min.css">
    <link rel="stylesheet" href="css/style.css">
    <script src="js/version.js"></script>
    <script src="js/skills.js"></script>
    <script src="js/framelib/rawdeflate.js"></script>
    <script src="js/framelib/rawinflate.js"></script>
    <script src="js/framelib/vue.min.js"></script>
    <script src="js/framelib/d3.min.js"></script>
    <script src="js/framelib/jquery.min.js" integrty="sha256-AIzaSyCVnmpEl1enwvdqddw1/GZfA4cGmEjw3d0=" crossorign="anonymous"></script>
    <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
    <div id="wrap">
        <div id="graphs">
            <section class="form-horizontal">
                <div id="sort" class="form-group bg-gray">
                    <h3 class="col-6">GRAPHS</h3>
                    <div class="col-2" v-for="(s,index) in ['入力順','MEAN順','MAX順']">
                        <label class="btn btn-lg wh100" style="padding-left:0;padding-right:0;" :class="[ index==sort ? 'btn-primary' : '' ]">
                            <input type="radio" :value="index" v-model="sort" v-on:change="gOrder(sort)">{{ s }}
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <div class="col-1">
                        <div style="position: relative;width: 1200%;z-index: -1;">
                            <svg class="desc"></svg>
                        </div>
                    </div>
                    <svg class="col-11 chart"></svg>
                </div>
                <div class="form-group">
                    <svg class="col-1" height="40"></svg>
                    <svg class="col-11 axis"></svg>
                </div>
            </section>
        </div>
        <div id="params">
            <section id="app" class="form-horizontal">
                <div class="form-group bg-gray">
                    <h3 class="col-6">PSO2ダメージ計算機</h3>
                    <h6 class="col-4" style="white-space: pre;"></h6>
                    <div class="col-2">
                        <button id="version" class="btn btn-lg wh100" style="padding:0;">？</button>
                    </div>
                </div>
            </section>
            <section id="settings" class="form-horizontal">
                <div class="form-group bg-gray">
                    <h3 class="col-6">SETTINGS</h3>
                    <h6 class="col-5" style="white-space: pre;">{{ summary_d }}</h6>
                    <div class="col-1">
                        <label class="btn btn-primary wh100">
                            <i class="icon" v-bind:class="(toggle.settings ? 'icon-plus' : 'icon-minus')"></i>
                            <input type="checkbox" v-model="toggle.settings">
                        </label>
                    </div>
                </div>
                <div v-if="!toggle.settings" class="form-group">
                    <div class="col-2" v-for="(val,index) in [{cmd:'add',name:'追加'},{cmd:'init',name:'初期値'},{cmd:'save',name:'セーブ'},{cmd:'load',name:'ロード'}]">
                        <button :id="val.cmd" class="btn btn-lg wh100">{{ val.name }}</button>
                    </div>
                    <div class="col-4 saveurl">
                        <input class="form-input input-lg left" readonly="true" type="text">
                    </div>
                    <div class="col-2">
                        <label class="form-label input-lg center">説明</label>
                    </div>
                    <div class="col-6">
                        <input class="form-input" placeholder="説明" v-model.lazy="params.settings.desc">
                        <input class="form-input input-lg left" type="text" style="display:none" v-model="params.settings.calcid">
                    </div>
                    <div class="col-2">
                        <label class="form-label input-lg center">ｸﾞﾙｰﾌﾟ</label>
                    </div>
                    <div class="col-2">
                        <input class="form-input input-lg left" type="text" v-model.lazy="params.settings.group">
                    </div>
                    <div class="col-2" v-for="(atktype,key) in ['打撃','射撃','ペット','テク']">
                        <label class="btn btn-lg wh100" style="padding-left:0;padding-right:0;" :class="[ key==params.settings.atktype ? 'btn-primary' : '' ]">
                            <input type="radio" :value="key" v-model="params.settings.atktype">{{ atktype }}
                        </label>
                    </div>
                    <div class="col-4">
                    </div>
                </div>
            </section>
            <section id="player" class="form-horizontal">
                <div class="form-group bg-gray">
                    <h3 class="col-6">PLAYER</h3>
                    <h6 class="col-5" style="white-space: pre;">{{ summary_p }}</h6>
                    <div class="col-1">
                        <label class="btn btn-primary wh100">
                            <i class="icon" v-bind:class="(toggle.player ? 'icon-plus' : 'icon-minus')"></i>
                            <input type="checkbox" v-model="toggle.player">
                        </label>
                    </div>
                </div>
                <template v-if="!toggle.player">
                    <range-text name="素手攻撃力" :max="4000" :min="500" :step="1" v-model="params.player.atk" :statuslabel="true"></range-text>
                    <range-text name="技量" :max="1600" :min="200" :step="1" v-model="params.player.dex"></range-text>
                    <range-text name="クリティカル率" :max="100" :min="0" :step="1" v-model="params.player.critical"></range-text>
                </template>
            </section>
            <section id="weapon" class="form-horizontal">
                <div class="form-group bg-gray">
                    <h3 class="col-6">WEAPON</h3>
                    <h6 class="col-5" style="white-space: pre;">{{ summary_w }}</h6>
                    <div class="col-1">
                        <label class="btn btn-primary wh100">
                            <i class="icon" v-bind:class="(toggle.weapon ? 'icon-plus' : 'icon-minus')"></i>
                            <input type="checkbox" v-model="toggle.weapon">
                        </label>
                    </div>
                </div>
                <template v-if="!toggle.weapon">
                    <range-text name="攻撃力" :max="3000" :min="500" :step="1" v-model="params.weapon.atk"></range-text>
                    <range-text name="OP(固定値)" :max="400" :min="0" :step="1" v-model="params.weapon.op" :statuslabel="true"></range-text>
                    <range-text name="属性値" :max="60" :min="0" :step="1" v-model="params.weapon.elm"></range-text>
                    <range-text v-for="(potential,index) in params.weapon.potentials" :key="index" 
                            @addarray="params.weapon.potentials.push({critical:false,rate:0})" 
                            @removearray="params.weapon.potentials.splice(index, 1)" :arrid="index" 
                            :name="'潜在S級倍率 '+(index+1)" :max="60" :min="0" :step="1" :rateswitch="true" v-model="params.weapon.potentials[index].rate">
                        <div class="col-2">
                            <label class="label label-lg wh100 center form-switch" v-bind:class="[potential.critical ? 'label-primary' : 'label-secondary']">
                                <input type="checkbox" v-model="potential.critical">
                                <i class="form-icon"></i>{{potential.critical ? "C倍率" : "倍率"}}
                            </label>
                        </div>
                    </range-text>
                </template>
            </section>
            <section id="equips" class="form-horizontal">
                <div class="form-group bg-gray">
                    <h3 class="col-6">EQUIPS</h3>
                    <h6 class="col-5" style="white-space: pre;">{{ summary_q }}</h6>
                    <div class="col-1">
                        <label class="btn btn-primary wh100">
                            <i class="icon" v-bind:class="(toggle.equips ? 'icon-plus' : 'icon-minus')"></i>
                            <input type="checkbox" v-model="toggle.equips">
                        </label>
                    </div>
                </div>
                <template v-if="!toggle.equips">
                    <range-text name="ユニOP&リングステ" :max="400" :min="0" :step="1" v-model="params.equips.unitsop" :statuslabel="true"></range-text>
                    <range-text v-for="(ring,index) in params.equips.rings" :key="index" 
                            @addarray="params.equips.rings.push({critical:false,rate:0})" 
                            @removearray="params.equips.rings.splice(index, 1)" :arrid="index" 
                            :name="'リング倍率 '+(index+1)" :max="60" :min="0" :step="1" :rateswitch="true" v-model="params.equips.rings[index].rate">
                        <div class="col-2">
                            <label class="label label-lg wh100 center form-switch" :class="[ring.critical ? 'label-primary' : 'label-secondary']">
                                <input type="checkbox" v-model="ring.critical">
                                <i class="form-icon"></i>{{ring.critical ? "C倍率" : "倍率"}}
                            </label>
                        </div>
                    </range-text>
                </template>
            </section>
            <section id="enemy" class="form-horizontal">
                <div class="form-group bg-gray">
                    <h3 class="col-6">ENEMY</h3>
                    <h6 class="col-5" style="white-space: pre;">{{ summary_e }}</h6>
                    <div class="col-1">
                        <label class="btn btn-primary wh100">
                            <i class="icon" v-bind:class="(toggle.enemy ? 'icon-plus' : 'icon-minus')"></i>
                            <input type="checkbox" v-model="toggle.enemy">
                        </label>
                    </div>
                </div>
                <template v-if="!toggle.enemy">
                    <range-text name="防御力" :max="1000" :min="100" :step="1" v-model="params.enemy.def"></range-text>
                    <range-text name="技量" :max="1000" :min="100" :step="1" v-model="params.enemy.dex"></range-text>
                    <range-text name="部位倍率" :max="5" :min="0" :step="0.1" v-model="params.enemy.partrate"></range-text>
                    <range-text name="属性倍率" :max="3" :min="0" :step="0.1" v-model="params.enemy.elmrate"></range-text>
                </template>
            </section>
            <section id="pa" class="form-horizontal">
                <div class="form-group bg-gray">
                    <h3 class="col-6">PA & 任意倍率</h3>
                    <h6 class="col-5" style="white-space: pre;">{{ summary_pa }}</h6>
                    <div class="col-1">
                        <label class="btn btn-primary wh100">
                            <i class="icon" v-bind:class="(toggle.paany ? 'icon-plus' : 'icon-minus')"></i>
                            <input type="checkbox" v-model="toggle.paany">
                        </label>
                    </div>
                </div>
                <div v-if="!toggle.paany" class="form-group">
                    <div class="col-2 center" style="padding-top:.4em;">
                        PA倍率
                    </div>
                    <div class="col-2 center">
                        <input class="form-input input-lg right" type="text" v-model.lazy="params.others.pa">
                    </div>
                    <div class="col-2 center" style="padding-top:.4em;">
                        PA技量補正
                    </div>
                    <div class="col-2 center">
                        <input class="form-input input-lg right" type="text" v-model.lazy="params.others.padex">
                    </div>
                    <div class="col-2 center" style="padding-top:.4em;">
                        任意倍率
                    </div>
                    <div class="col-2 center">
                        <input class="form-input input-lg right" type="text" v-model.lazy="params.others.any_r">
                    </div>
                </div>
            </section>
            <section id="skills" class="form-horizontal">
                <div class="form-group bg-gray">
                    <h3 class="col-6">COMMON & CLASS SKILLS</h3>
                    <h6 class="col-5" style="white-space: pre;">{{ summary_s }}</h6>
                    <div class="col-1">
                        <label class="btn btn-primary wh100">
                            <i class="icon" v-bind:class="(toggle.skills ? 'icon-plus' : 'icon-minus')"></i>
                            <input type="checkbox" v-model="toggle.skills">
                        </label>
                    </div>
                </div>
                <template v-if="!toggle.skills">
                    <div class="tab tab-block">
                        <template v-for="cls in ['Co','Hu','Fi','Ra','Gu','Fo','Te','Br','Bo','Su','Hr']">
                            <label class="tab-item center" v-bind:class="{ active:hasClass(cls) }" :id="'tab-'+cls">
                                <input type="checkbox" v-model="hasClass(cls)" value="1" v-on:click.stop.prevent="changeClass(cls)">{{ cls }}
                            </label>
                        </template>
                    </div>
                    <template v-for="cls in ['Co','Hu','Fi','Ra','Gu','Fo','Te','Br','Bo','Su','Hr']">
                        <div class="classskills" v-if="hasClass(cls)">
                            <div class="form-group" v-for="skill in classSkills(cls)">
                                <div class="col-3 center" style="padding-top:.4em;">
                                    {{ skill.skillName }}
                                </div>
                                <div class="col-9" style="display:flex;">
                                    <div v-for="(lbl,idx) in skill.label" v-bind:class="idx==0 ? 'skillnone' : 'skill'">
                                        <label class="btn btn-lg wh100 center" v-bind:class="[ idx==(!params.others.skills[skill.id] ? 0 : params.others.skills[skill.id]) ? 'btn-primary' : '' ]">
                                            <input type="radio" :value="idx" v-model="params.others.skills[skill.id]">{{ lbl }}
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                </template>
            </section>
            <!-- ポップアップ -->
            <div id="popup">
                <button class="btn" style="display:block;margin:0 0 0 auto;" id="close">×</button>
                <div class="form-horizontal">
                    <div class="form-group">
                        <h4 class="col-9">このシミュについて{{ "v"+version_r[0].ver.toFixed(2)}}</h4>
                        <div class="col-3">
                            作者:<a href="https://twitter.com/usousuke" target="_blank">@usousuke</a>
                        </div>
                    </div>
                </div>
                <p>
                    <a href="https://twitter.com/6elz" target="_blank">@6elz</a>氏の<a href="http://4rt.info/psod/">http://4rt.info/psod/</a>を参考に作成しました。<br>
                    改めて@6elz氏お礼申し上げます。私個人の勉強という側面が大きいのですが、公開の許可を頂けて非常に感謝しております。
                </p>
                <h4>コンセプト</h4>
                <p>
                    自分がpso2を辞めたときのためにできるだけ単純に作りました。<br>
                    単純な倍率系が増えたくらいでは変更しなくてもいいくらいに作っています。<br>
                </p>
                <h4>個人的な改良点</h4>
                <p>
                    <strong>クリティカル時の倍率上昇系をいじれるようにしています。</strong>これをしたかったのがほとんどです。<br>
                    倍率系の存在場所が増え、任意倍率で調整するのが厳しくなってきたので<strong>武器潜在の倍率、リング倍率を任意に増やせるように</strong>しています。
                </p>
                <section class="form-horizontal">
                    <h3 class="col-12 bg-gray">VERSION</h3>
                    <div class="form-group" v-for="v in version_r">
                        <div class="col-2 center bg-primary">{{ "ver." + v.ver.toFixed(2)}}</div>
                        <div class="col-4" style="padding-left:10px;white-space: pre;">{{ v.desc }}</div>
                        <div class="col-4" style="padding-left:10px;white-space: pre;">{{ v.next }}</div>
                        <div class="col-2 center">{{ v.date }}</div>
                    </div>
                </section>
            </div>
        </div>
    </div>
    <!-- レイヤー -->
    <div id="layer"></div>
    <script src="js/graphs.js"></script>
    <script src="js/dmgcalc.js"></script>
    <script>
        var repository="https://rsskkr.github.io/pso2ds/?d=";
        $("#append").click(function(){
            gAppend();
        });
        $("#update").click(function(){
            gUpdate();
        });
        // show popupボタンクリック時の処理
        $(document).on("click","#version",function(e) {
            $('#popup, #layer').show();
        });
        // レイヤー/ポップアップのcloseボタンクリック時の処理
        $('#close, #layer').click(function(e) {
            $('#popup, #layer').hide();
        });
        $(document).on("click","#init",function(){
            pInit();
        });
        $(document).on("click","#add",function(){
            pAdd();
        });
        $(document).on("click","#save",function(){
            shorten(repository+deflate(JSON.stringify(calcs))).then(function(response) {
                // response.result.id に短縮URLが入っている
                var shortUrl = response.result.id;
                // 画面に表示
                $(".saveurl>input").val(shortUrl);
                $(".saveurl").show();
            });
        });
        $(document).on("click","#load",function(){
            var shorturl=window.prompt("URLを入力してください。","")
            if (!shorturl){
                alert("キャンセルしました。");
            } else {
                expanden(shorturl).then(function(response){
                    var longUrl = response.result.longUrl;
                    var p=longUrl.replace(repository,"")
                    
                    // json文字列復元
                    try {
                        var j = JSON.parse(inflate(p));
                        
                        alert("URLからグラフをロードします。");
                        
                        if (current_params.graph.line==init_params.graph.line && calcs.length==1){
                            calcs=[];
                            d3.select('.chart').selectAll("g").remove();
                        }
                        
                        for (var i=0;i<j.length;i++){
                            $.guid++
                            j[i].settings.dmgid=$.guid;
                            calcs.push(j[i]);
                        }
                        gAppend();
                    }
                    catch (ex) {
                        alert("urlが不正です。");
                    }
                });
            }
        });
        
        var timer = false;
        $(window).resize(function() {
            if (timer !== false) {
                clearTimeout(timer);
            }
            timer = setTimeout(function() {
                gUpdate();
            }, 200);
        });
        
    // 圧縮関数 (要deflate.js)
    function deflate(val) {
        val = encodeURIComponent(val); // UTF16 → UTF8
        val = RawDeflate.deflate(val); // 圧縮
        val = btoa(val); // base64エンコード
        return val;
    }

    // 復号関数 (要inflate.js)
    function inflate(val) {
        val = atob(val); // base64デコード
        val = RawDeflate.inflate(val); // 復号
        val = decodeURIComponent(val); // UTF8 → UTF16
        return val;
    }
    var v = $("[src*='jquery']").attr('integrty').slice(7,46).replace("/","_");
    
    $(function(){
        // urlパラメータ解析
        if (location.search.length>0){
            // パラメータ取得
            var p=location.search.substring(3);
            // json文字列復元
            try {
                var j = JSON.parse(inflate(p));
                
                alert("URLからグラフをロードします。");
                
                calcs=[];
                d3.select('.chart').selectAll("g").remove();
                for (var i=0;i<j.length;i++){
                    $.guid++
                    j[i].settings.dmgid=$.guid;
                    calcs.push(j[i]);
                }
                pSelect();
                gAppend();
            }
            catch (ex) {
                alert("urlが不正です。");
            }
        }
    });

    
    </script>
    <script src="js/urlshortner.js"></script>
</body>
</html>
